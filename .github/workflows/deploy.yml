name: Deploy to EC2

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    branches: [main]
    types:
      - completed
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/tableorder

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e

          echo "=== ë°°í¬ ì‹œì‘ ==="
          cd /home/ubuntu/tableorder || {
            echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±"
            mkdir -p /home/ubuntu/tableorder
            cd /home/ubuntu/tableorder
          }

          echo "=== Docker Compose íŒŒì¼ ë‹¤ìš´ë¡œë“œ ==="
          curl -o docker-compose.yml https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml

          echo "=== ë°ì´í„° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ==="
          mkdir -p data/db data/media
          chmod 755 data data/db data/media

          echo "=== í™˜ê²½ë³€ìˆ˜ ì„¤ì • ==="
          cat > .env << EOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=localhost,127.0.0.1,${{ secrets.EC2_HOST }}
          DOCKER_IMAGE=${{ env.DOCKER_IMAGE }}:latest
          EOF

          echo "=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ==="
          docker-compose down --remove-orphans || true

          echo "=== ìµœì‹  ì´ë¯¸ì§€ í’€ ==="
          docker pull ${{ env.DOCKER_IMAGE }}:latest

          echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ==="
          docker-compose up -d

          echo "=== í—¬ìŠ¤ì²´í¬ ==="
          sleep 30
          for i in {1..10}; do
            if curl -f http://localhost/admin/login/ >/dev/null 2>&1; then
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë¨"
              break
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10"
            sleep 10
          done

          echo "=== ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ==="
          docker image prune -f

          echo "=== ë°°í¬ ì™„ë£Œ ==="
          docker-compose ps

    - name: Notify Success
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://${{ secrets.EC2_HOST }}"

    - name: Notify Failure
      if: failure()
      run: echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."