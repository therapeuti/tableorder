name: Auto Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        debug: true
        script: |
          echo "=== 디버깅 정보 ==="
          whoami
          pwd
          ls -la /home/ubuntu/
          echo "=== 프로젝트 디렉토리로 이동 ==="
          cd /home/ubuntu/tableorder || { echo "디렉토리 없음, 생성 중..."; mkdir -p /home/ubuntu/tableorder; cd /home/ubuntu/tableorder; }
          echo "=== Git 작업 ==="
          git pull origin main || echo "git pull 실패"
          echo "=== 환경 설정 ==="
          cp config/.env.simple .env || echo ".env 설정 실패"
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,${{ secrets.EC2_HOST }}" >> .env
          echo "=== Docker 작업 ==="
          docker-compose down || echo "컨테이너 중단 실패"
          docker-compose up -d --build || echo "Docker 빌드 실패"
          echo "=== 완료 ==="
    
    - name: Notify Success
      if: success()
      run: echo "🎉 배포 성공!"
    
    - name: Notify Failure  
      if: failure()
      run: echo "❌ 배포 실패!"