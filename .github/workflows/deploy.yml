name: Auto Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        debug: true
        script: |
          echo "=== ë””ë²„ê¹… ì •ë³´ ==="
          whoami
          pwd
          ls -la /home/ubuntu/
          echo "=== í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ==="
          cd /home/ubuntu/tableorder || { echo "ë””ë ‰í† ë¦¬ ì—†ìŒ, ìƒì„± ì¤‘..."; mkdir -p /home/ubuntu/tableorder; cd /home/ubuntu/tableorder; }
          echo "=== Git ì‘ì—… ==="
          git pull origin main || echo "git pull ì‹¤íŒ¨"
          echo "=== í™˜ê²½ ì„¤ì • ==="
          cp config/.env.simple .env || echo ".env ì„¤ì • ì‹¤íŒ¨"
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,${{ secrets.EC2_HOST }}" >> .env
          echo "=== Docker ì‘ì—… ==="
          docker-compose down || echo "ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ì‹¤íŒ¨"
          docker-compose up -d --build || echo "Docker ë¹Œë“œ ì‹¤íŒ¨"
          echo "=== ì™„ë£Œ ==="
    
    - name: Notify Success
      if: success()
      run: echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
    
    - name: Notify Failure  
      if: failure()
      run: echo "âŒ ë°°í¬ ì‹¤íŒ¨!"